---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings = [] } = Astro.props;
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
---

{tocHeadings.length > 0 && (
  <div class="sticky top-32">
    <h4 class="text-xs font-semibold text-ink-faint uppercase tracking-wider mb-4">On this page</h4>
    <nav class="space-y-1">
      {tocHeadings.map(heading => (
        <a
          href={`#${heading.slug}`}
          class:list={[
            'toc-link block text-sm leading-relaxed transition-colors hover:text-accent',
            heading.depth === 3 ? 'pl-3 text-ink-faint' : 'text-ink-muted',
          ]}
          data-slug={heading.slug}
        >
          {heading.text}
        </a>
      ))}
    </nav>
  </div>
)}

<style>
  .toc-link.active {
    color: var(--color-accent);
    font-weight: 500;
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    if (tocLinks.length === 0) return;

    const headingEls = Array.from(tocLinks).map(link => {
      const slug = link.getAttribute('data-slug');
      return slug ? document.getElementById(slug) : null;
    }).filter(Boolean) as HTMLElement[];

    if (headingEls.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            tocLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.toc-link[data-slug="${entry.target.id}"]`);
            activeLink?.classList.add('active');
          }
        }
      },
      { rootMargin: '-80px 0px -60% 0px', threshold: 0 }
    );

    headingEls.forEach(el => observer.observe(el));
  });
</script>
